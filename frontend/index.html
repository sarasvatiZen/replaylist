<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>REPLAYLIST</title>
        <link rel="stylesheet" href="./style.css" />
    </head>
    <body>
        <div id="app"></div>

        <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

        <!-- ✅ Elm の JS バンドルを必ず先に読み込む -->
        <script src="main.js"></script>

        <script>
            var app = Elm.Main.init({ node: document.getElementById("app") });

            app.ports.appleLogin.subscribe(async () => {
                try {
                    const { token: devToken } = await (
                        await fetch("/api/apple/devtoken")
                    ).json();

                    MusicKit.configure({
                        developerToken: devToken,
                        app: { name: "Replaylist", build: "1.0" },
                    });

                    const music = MusicKit.getInstance();
                    const userToken = await music.authorize();

                    app.ports.receiveAppleUserToken.send(userToken);
                } catch (err) {
                    console.error("Apple login failed:", err);
                }
            });
        </script>
    </body>
</html>
